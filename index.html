<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æ–‡å–®å­—å­¸ç¿’</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: 600px;
        }
        
        .screen {
            padding: 30px 20px;
            display: none;
            flex-direction: column;
            height: 100%;
        }
        
        .active {
            display: flex;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #4a5568;
            font-size: 1.5rem;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 16px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
        }
        
        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .btn-secondary:hover {
            background: #cbd5e0;
        }
        
        .setting-group {
            margin: 15px 0;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #4a5568;
        }
        
        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .quiz-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .question {
            font-size: 2rem;
            text-align: center;
            margin: 40px 0;
            min-height: 60px;
            color: #2d3748;
        }
        
        .options {
            display: grid;
            gap: 10px;
            margin: 20px 0;
        }
        
        .option-btn {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }
        
        .option-btn:hover {
            border-color: #667eea;
            background: #edf2f7;
        }
        
        .answer {
            background: #f0fff4;
            border: 2px solid #9ae6b4;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .controls .btn {
            flex: 1;
        }
        
        .progress {
            text-align: center;
            color: #718096;
            margin-bottom: 10px;
        }
        
        .hidden {
            display: none;
        }
        
        .speak-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #667eea;
            margin-left: 10px;
        }
        
        .correct {
            background: #9ae6b4 !important;
            border-color: #48bb78 !important;
        }
        
        .incorrect {
            background: #fed7d7 !important;
            border-color: #f56565 !important;
        }
        
        .stats {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .env-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #e53e3e;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- ç’°å¢ƒæ¨™ç¤º -->
    <div id="envBadge" class="env-badge" style="display: none;">æœ¬åœ°æ¨¡å¼</div>
    
    <div class="container">
        <!-- ä¸»é¸å–® -->
        <div id="mainMenu" class="screen active">
            <h1>æ—¥æ–‡å–®å­—å­¸ç¿’</h1>
            <button class="btn" onclick="app.showScreen('quizSetup')">æ¸¬é©—æ¨¡å¼</button>
            <button class="btn" onclick="app.showScreen('studySetup')">èƒŒèª¦æ¨¡å¼</button>
            <button class="btn btn-secondary" onclick="app.showScreen('progressScreen')">å­¸ç¿’é€²åº¦</button>
        </div>
        
        <!-- æ¸¬é©—è¨­å®š -->
        <div id="quizSetup" class="screen">
            <h1>æ¸¬é©—è¨­å®š</h1>
            <div class="setting-group">
                <label>æ¸¬é©—é¡å‹</label>
                <select id="quizType">
                    <option value="noun">åè©</option>
                    <option value="verb">å‹•è©</option>
                    <option value="adjective">å½¢å®¹è©</option>
                    <option value="adverb">å‰¯è©</option>
                    <option value="grammar">æ–‡æ³•</option>
                    <option value="custom">è‡ªå®šç¾©IDç¯„åœ</option>
                </select>
            </div>
            <div class="setting-group" id="customRangeGroup" style="display:none">
                <label>IDç¯„åœ (ä¾‹: N001-N050)</label>
                <input type="text" id="customRange" placeholder="N001-N050">
            </div>
            <div class="setting-group">
                <label>é¡Œæ•¸</label>
                <select id="questionCount">
                    <option value="5">5é¡Œ</option>
                    <option value="10" selected>10é¡Œ</option>
                    <option value="20">20é¡Œ</option>
                    <option value="30">30é¡Œ</option>
                </select>
            </div>
            <button class="btn" onclick="app.startQuiz()">é–‹å§‹æ¸¬é©—</button>
            <button class="btn btn-secondary" onclick="app.showScreen('mainMenu')">è¿”å›</button>
        </div>
        
        <!-- èƒŒèª¦è¨­å®š -->
        <div id="studySetup" class="screen">
            <h1>èƒŒèª¦è¨­å®š</h1>
            <div class="setting-group">
                <label>å­¸ç¿’é¡å‹</label>
                <select id="studyType">
                    <option value="noun">åè©</option>
                    <option value="verb">å‹•è©</option>
                    <option value="adjective">å½¢å®¹è©</option>
                    <option value="adverb">å‰¯è©</option>
                    <option value="grammar">æ–‡æ³•</option>
                    <option value="custom">è‡ªå®šç¾©IDç¯„åœ</option>
                </select>
            </div>
            <div class="setting-group" id="studyCustomRangeGroup" style="display:none">
                <label>IDç¯„åœ (ä¾‹: N001-N050)</label>
                <input type="text" id="studyCustomRange" placeholder="N001-N050">
            </div>
            <button class="btn" onclick="app.startStudy()">é–‹å§‹èƒŒèª¦</button>
            <button class="btn btn-secondary" onclick="app.showScreen('mainMenu')">è¿”å›</button>
        </div>
        
        <!-- æ¸¬é©—ç•«é¢ -->
        <div id="quizScreen" class="screen">
            <div class="progress" id="progressText">1/10</div>
            <h1>æ¸¬é©—ä¸­</h1>
            <div class="quiz-area">
                <div class="question" id="currentQuestion">
                    <span id="questionText"></span>
                    <button class="speak-btn" onclick="app.speakCurrentWord()">ğŸ”Š</button>
                </div>
                <div class="options" id="optionsContainer"></div>
                <div class="answer" id="answerDisplay"></div>
                <div class="controls">
                    <button class="btn" id="showAnswerBtn" onclick="app.showAnswer()">é¡¯ç¤ºè§£ç­”</button>
                    <button class="btn btn-secondary" id="nextBtn" onclick="app.nextQuestion()" style="display:none">ä¸‹ä¸€é¡Œ</button>
                </div>
            </div>
        </div>
        
        <!-- èƒŒèª¦ç•«é¢ -->
        <div id="studyScreen" class="screen">
            <div class="progress" id="studyProgressText">1/10</div>
            <h1>èƒŒèª¦ä¸­</h1>
            <div class="quiz-area">
                <div class="question" id="studyQuestion">
                    <span id="studyQuestionText"></span>
                    <button class="speak-btn" onclick="app.speakCurrentStudyWord()">ğŸ”Š</button>
                </div>
                <div class="answer" id="studyAnswerDisplay"></div>
                <div class="controls">
                    <button class="btn" onclick="app.showStudyAnswer()">é¡¯ç¤ºè§£ç­”</button>
                    <button class="btn btn-secondary" onclick="app.nextStudyWord()">ä¸‹ä¸€å€‹</button>
                </div>
            </div>
        </div>
        
        <!-- é€²åº¦ç•«é¢ -->
        <div id="progressScreen" class="screen">
            <h1>å­¸ç¿’é€²åº¦</h1>
            <div id="progressStats"></div>
            <button class="btn btn-secondary" onclick="app.showScreen('mainMenu')">è¿”å›</button>
        </div>
    </div>

    <script>
        // ä½¿ç”¨å‘½åç©ºé–“é¿å…è®Šæ•¸è¡çª
        const app = {
            // å–®å­—è³‡æ–™åº«
            vocabularyData: {
                nouns: [
                    {
                        "id": "N001",
                        "hiragana": "ã•ãã‚‰",
                        "kanji": "æ¡œ",
                        "meaning": "æ«»èŠ±",
                        "usage": "æ—¥æœ¬ã®æ¡œã¯ã¨ã¦ã‚‚ç¾ã—ã„ã€‚"
                    },
                    {
                        "id": "N002", 
                        "hiragana": "ã¤ã",
                        "kanji": "æœˆ",
                        "meaning": "æœˆäº®",
                        "usage": "ä»Šå¤œã®æœˆã¯ä¸¸ã„ã€‚"
                    },
                    {
                        "id": "N003",
                        "hiragana": "ã¯ãª",
                        "kanji": "èŠ±",
                        "meaning": "èŠ±",
                        "usage": "åº­ã«ãã‚Œã„ãªèŠ±ãŒå’²ã„ã¦ã„ã‚‹ã€‚"
                    },
                    {
                        "id": "N004",
                        "hiragana": "ã„ãˆ",
                        "kanji": "å®¶",
                        "meaning": "å®¶",
                        "usage": "ç§ã®å®¶ã¯é§…ã®è¿‘ãã§ã™ã€‚"
                    },
                    {
                        "id": "N005",
                        "hiragana": "ãŒã£ã“ã†",
                        "kanji": "å­¸æ ¡",
                        "meaning": "å­¸æ ¡",
                        "usage": "å­¸æ ¡ã¸è¡Œãã€‚"
                    }
                ],
                
                verbs: [
                    {
                        "id": "V001",
                        "hiragana": "ãŸã¹ã‚‹",
                        "kanji": "é£Ÿã¹ã‚‹",
                        "meaning": "åƒ",
                        "usage": "ã”é£¯ã‚’é£Ÿã¹ã‚‹"
                    },
                    {
                        "id": "V002",
                        "hiragana": "ã®ã‚€", 
                        "kanji": "é£²ã‚€",
                        "meaning": "å–",
                        "usage": "æ°´ã‚’é£²ã‚€"
                    },
                    {
                        "id": "V003",
                        "hiragana": "ã„ã",
                        "kanji": "è¡Œã",
                        "meaning": "å»",
                        "usage": "å­¸æ ¡ã¸è¡Œã"
                    },
                    {
                        "id": "V004",
                        "hiragana": "ãã‚‹",
                        "kanji": "ä¾†ã‚‹",
                        "meaning": "ä¾†",
                        "usage": "æ—¥æœ¬ã¸ä¾†ã‚‹"
                    },
                    {
                        "id": "V005",
                        "hiragana": "ã¿ã‚‹",
                        "kanji": "è¦‹ã‚‹",
                        "meaning": "çœ‹",
                        "usage": "ãƒ†ãƒ¬ãƒ“ã‚’è¦‹ã‚‹"
                    }
                ],
                
                adjectives: [
                    {
                        "id": "AJ001",
                        "hiragana": "ã†ã¤ãã—ã„",
                        "kanji": "ç¾ã—ã„",
                        "meaning": "ç¾éº—çš„",
                        "usage": "ç¾ã—ã„æ™¯è‰²"
                    },
                    {
                        "id": "AJ002",
                        "hiragana": "ãŠãŠãã„",
                        "kanji": "å¤§ãã„",
                        "meaning": "å¤§çš„",
                        "usage": "å¤§ãã„å®¶"
                    },
                    {
                        "id": "AJ003",
                        "hiragana": "ã¡ã„ã•ã„",
                        "kanji": "å°ã•ã„",
                        "meaning": "å°çš„",
                        "usage": "å°ã•ã„çŠ¬"
                    },
                    {
                        "id": "AJ004",
                        "hiragana": "ãŸã®ã—ã„",
                        "kanji": "æ¥½ã—ã„",
                        "meaning": "å¿«æ¨‚çš„",
                        "usage": "æ¥½ã—ã„æ—…è¡Œ"
                    },
                    {
                        "id": "AJ005",
                        "hiragana": "ãŠã„ã—ã„",
                        "kanji": null,
                        "meaning": "ç¾å‘³çš„",
                        "usage": "ãŠã„ã—ã„æ–™ç†"
                    }
                ],
                
                adverbs: [
                    {
                        "id": "AV001",
                        "hiragana": "ã‚†ã£ãã‚Š",
                        "kanji": null,
                        "meaning": "æ…¢æ…¢åœ°",
                        "usage": "ã‚†ã£ãã‚Šè©±ã™"
                    },
                    {
                        "id": "AV002",
                        "hiragana": "ã¯ã‚„ã",
                        "kanji": "æ—©ã",
                        "meaning": "å¿«é€Ÿåœ°",
                        "usage": "æ—©ãèµ°ã‚‹"
                    },
                    {
                        "id": "AV003",
                        "hiragana": "ã¨ã¦ã‚‚",
                        "kanji": null,
                        "meaning": "éå¸¸",
                        "usage": "ã¨ã¦ã‚‚ç¾ã—ã„"
                    },
                    {
                        "id": "AV004",
                        "hiragana": "ã™ã“ã—",
                        "kanji": "å°‘ã—",
                        "meaning": "ä¸€é»",
                        "usage": "å°‘ã—å¾…ã¤"
                    },
                    {
                        "id": "AV005",
                        "hiragana": "ã‚ˆã",
                        "kanji": null,
                        "meaning": "ç¶“å¸¸",
                        "usage": "ã‚ˆãè¡Œã"
                    }
                ],
                
                grammar: [
                    {
                        "id": "G001",
                        "hiragana": "ï½ã¦ãã ã•ã„",
                        "kanji": null,
                        "meaning": "è«‹ï½",
                        "usage": "åº§ã£ã¦ãã ã•ã„ã€‚"
                    },
                    {
                        "id": "G002",
                        "hiragana": "ï½ãŸã„",
                        "kanji": null,
                        "meaning": "æƒ³è¦ï½",
                        "usage": "é£Ÿã¹ãŸã„ã€‚"
                    },
                    {
                        "id": "G003",
                        "hiragana": "ï½ãªã‘ã‚Œã°ãªã‚‰ãªã„",
                        "kanji": null,
                        "meaning": "å¿…é ˆï½",
                        "usage": "å‹‰å¼·ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚"
                    },
                    {
                        "id": "G004",
                        "hiragana": "ï½ã¦ã‚‚ã„ã„",
                        "kanji": null,
                        "meaning": "å¯ä»¥ï½",
                        "usage": "å¸°ã£ã¦ã‚‚ã„ã„ã§ã™ã‹ã€‚"
                    },
                    {
                        "id": "G005",
                        "hiragana": "ï½ã¦ã¯ã„ã‘ãªã„",
                        "kanji": null,
                        "meaning": "ä¸å¯ä»¥ï½",
                        "usage": "ã“ã“ã§ã‚¿ãƒã‚³ã‚’å¸ã£ã¦ã¯ã„ã‘ãªã„ã€‚"
                    }
                ]
            },

            // å…¨åŸŸè®Šæ•¸
            currentVocab: [],
            currentQuestionIndex: 0,
            score: 0,
            quizMode: true,
            studyWords: [],
            currentStudyIndex: 0,
            isLocal: window.location.protocol === 'file:',

            // åˆå§‹åŒ–
            init: function() {
                // é¡¯ç¤ºç’°å¢ƒæ¨™ç¤º
                if (this.isLocal) {
                    document.getElementById('envBadge').style.display = 'block';
                }
                
                // åªåœ¨ä¼ºæœå™¨ç’°å¢ƒè¨»å†Š Service Worker
                if ('serviceWorker' in navigator && !this.isLocal) {
                    // å‹•æ…‹è¼‰å…¥ manifest.json
                    const link = document.createElement('link');
                    link.rel = 'manifest';
                    link.href = 'manifest.json';
                    document.head.appendChild(link);
                    
                    navigator.serviceWorker.register('sw.js')
                        .then(() => console.log('SW Registered'))
                        .catch(err => console.log('SW Error:', err));
                }
                
                // äº‹ä»¶ç›£è½
                document.getElementById('quizType').addEventListener('change', this.toggleCustomRange);
                document.getElementById('studyType').addEventListener('change', this.toggleStudyCustomRange);
                
                // è¼‰å…¥å­¸ç¿’é€²åº¦
                this.loadProgress();
                
                console.log('åŸ·è¡Œç’°å¢ƒ:', this.isLocal ? 'æœ¬åœ°æ¨¡å¼' : 'ä¼ºæœå™¨æ¨¡å¼');
            },

            // é¡¯ç¤ºç•«é¢
            showScreen: function(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenId).classList.add('active');
                
                if (screenId === 'progressScreen') {
                    this.showProgressStats();
                }
            },

            // åˆ‡æ›è‡ªå®šç¾©ç¯„åœé¡¯ç¤º
            toggleCustomRange: function() {
                const type = document.getElementById('quizType').value;
                document.getElementById('customRangeGroup').style.display = 
                    type === 'custom' ? 'block' : 'none';
            },

            toggleStudyCustomRange: function() {
                const type = document.getElementById('studyType').value;
                document.getElementById('studyCustomRangeGroup').style.display = 
                    type === 'custom' ? 'block' : 'none';
            },

            // é–‹å§‹æ¸¬é©—
            startQuiz: function() {
                const type = document.getElementById('quizType').value;
                const range = document.getElementById('customRange').value;
                const count = parseInt(document.getElementById('questionCount').value);
                
                this.currentVocab = this.loadVocabulary(type, range);
                if (this.currentVocab.length === 0) {
                    alert('æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„å–®å­—ï¼');
                    return;
                }
                
                // éš¨æ©Ÿé¸æ“‡æŒ‡å®šæ•¸é‡çš„å–®å­—
                this.currentVocab = this.shuffleArray(this.currentVocab).slice(0, count);
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.quizMode = true;
                
                this.showScreen('quizScreen');
                this.showQuestion();
            },

            // é–‹å§‹èƒŒèª¦
            startStudy: function() {
                const type = document.getElementById('studyType').value;
                const range = document.getElementById('studyCustomRange').value;
                
                this.studyWords = this.loadVocabulary(type, range);
                if (this.studyWords.length === 0) {
                    alert('æ²’æœ‰æ‰¾åˆ°ç¬¦åˆçš„å–®å­—ï¼');
                    return;
                }
                
                this.currentStudyIndex = 0;
                this.quizMode = false;
                
                this.showScreen('studyScreen');
                this.showStudyWord();
            },

            // è¼‰å…¥å–®å­—è³‡æ–™
            loadVocabulary: function(type, range) {
                let words = [];
                switch(type) {
                    case 'noun': 
                        words = this.vocabularyData.nouns;
                        break;
                    case 'verb': 
                        words = this.vocabularyData.verbs;
                        break;
                    case 'adjective': 
                        words = this.vocabularyData.adjectives;
                        break;
                    case 'adverb': 
                        words = this.vocabularyData.adverbs;
                        break;
                    case 'grammar': 
                        words = this.vocabularyData.grammar;
                        break;
                    case 'custom': 
                        words = this.loadCustomRange(range);
                        break;
                    default: 
                        words = this.vocabularyData.nouns;
                }
                
                return words;
            },

            // è¼‰å…¥è‡ªå®šç¾©ç¯„åœ
            loadCustomRange: function(range) {
                const allWords = [
                    ...this.vocabularyData.nouns,
                    ...this.vocabularyData.verbs,
                    ...this.vocabularyData.adjectives,
                    ...this.vocabularyData.adverbs,
                    ...this.vocabularyData.grammar
                ];
                
                if (range) {
                    const [start, end] = range.split('-');
                    return allWords.filter(word => {
                        return word.id >= start && word.id <= end;
                    });
                }
                
                return allWords;
            },

            // é¡¯ç¤ºæ¸¬é©—é¡Œç›®
            showQuestion: function() {
                const current = this.currentVocab[this.currentQuestionIndex];
                document.getElementById('questionText').textContent = current.hiragana;
                document.getElementById('progressText').textContent = 
                    `${this.currentQuestionIndex + 1}/${this.currentVocab.length}`;
                document.getElementById('answerDisplay').style.display = 'none';
                document.getElementById('showAnswerBtn').style.display = 'block';
                document.getElementById('nextBtn').style.display = 'none';
                
                // ç”Ÿæˆé¸é …
                const options = this.generateOptions(current);
                const optionsContainer = document.getElementById('optionsContainer');
                optionsContainer.innerHTML = '';
                
                const self = this;
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'option-btn';
                    button.textContent = option;
                    button.onclick = function() {
                        self.checkAnswer(option, current);
                    };
                    optionsContainer.appendChild(button);
                });
            },

            // é¡¯ç¤ºèƒŒèª¦å–®å­—
            showStudyWord: function() {
                const current = this.studyWords[this.currentStudyIndex];
                document.getElementById('studyQuestionText').textContent = current.hiragana;
                document.getElementById('studyProgressText').textContent = 
                    `${this.currentStudyIndex + 1}/${this.studyWords.length}`;
                document.getElementById('studyAnswerDisplay').style.display = 'none';
            },

            // ç”Ÿæˆé¸é …
            generateOptions: function(correctWord) {
                const options = [correctWord.meaning];
                const otherWords = this.currentVocab.filter(word => word.id !== correctWord.id);
                const shuffledOthers = this.shuffleArray(otherWords);
                
                // åŠ å…¥3å€‹éŒ¯èª¤é¸é …
                for (let i = 0; i < 3 && i < shuffledOthers.length; i++) {
                    options.push(shuffledOthers[i].meaning);
                }
                
                return this.shuffleArray(options);
            },

            // æª¢æŸ¥ç­”æ¡ˆ
            checkAnswer: function(selected, correct) {
                const isCorrect = selected === correct.meaning;
                if (isCorrect) this.score++;
                
                this.showAnswer();
                
                // ç¦ç”¨æ‰€æœ‰é¸é …æŒ‰éˆ•
                document.querySelectorAll('.option-btn').forEach(btn => {
                    btn.disabled = true;
                    if (btn.textContent === correct.meaning) {
                        btn.classList.add('correct');
                    } else if (btn.textContent === selected && !isCorrect) {
                        btn.classList.add('incorrect');
                    }
                });
                
                document.getElementById('showAnswerBtn').style.display = 'none';
                document.getElementById('nextBtn').style.display = 'block';
            },

            // é¡¯ç¤ºè§£ç­”
            showAnswer: function() {
                const current = this.currentVocab[this.currentQuestionIndex];
                const answerDiv = document.getElementById('answerDisplay');
                answerDiv.innerHTML = `
                    <strong>${current.kanji || current.hiragana}</strong><br>
                    ä¸­æ–‡: ${current.meaning}<br>
                    ${current.usage ? `ç”¨æ³•: ${current.usage}` : ''}
                `;
                answerDiv.style.display = 'block';
            },

            // é¡¯ç¤ºèƒŒèª¦è§£ç­”
            showStudyAnswer: function() {
                const current = this.studyWords[this.currentStudyIndex];
                const answerDiv = document.getElementById('studyAnswerDisplay');
                answerDiv.innerHTML = `
                    <strong>${current.kanji || current.hiragana}</strong><br>
                    ä¸­æ–‡: ${current.meaning}<br>
                    ${current.usage ? `ç”¨æ³•: ${current.usage}` : ''}
                `;
                answerDiv.style.display = 'block';
            },

            // ä¸‹ä¸€é¡Œ
            nextQuestion: function() {
                this.currentQuestionIndex++;
                if (this.currentQuestionIndex < this.currentVocab.length) {
                    this.showQuestion();
                } else {
                    this.endQuiz();
                }
            },

            // ä¸‹ä¸€å€‹èƒŒèª¦å–®å­—
            nextStudyWord: function() {
                this.currentStudyIndex++;
                if (this.currentStudyIndex < this.studyWords.length) {
                    this.showStudyWord();
                } else {
                    alert('èƒŒèª¦å®Œæˆï¼');
                    this.showScreen('mainMenu');
                }
            },

            // çµæŸæ¸¬é©—
            endQuiz: function() {
                const percentage = Math.round((this.score / this.currentVocab.length) * 100);
                alert(`æ¸¬é©—å®Œæˆï¼\nå¾—åˆ†: ${this.score}/${this.currentVocab.length} (${percentage}%)`);
                
                // å„²å­˜é€²åº¦
                this.saveProgress(this.score, this.currentVocab.length);
                this.showScreen('mainMenu');
            },

            // æ–‡å­—è½‰èªéŸ³
            speakText: function(text) {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'ja-JP';
                    utterance.rate = 0.8;
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åŠŸèƒ½');
                }
            },

            speakCurrentWord: function() {
                const current = this.currentVocab[this.currentQuestionIndex];
                this.speakText(current.hiragana);
            },

            speakCurrentStudyWord: function() {
                const current = this.studyWords[this.currentStudyIndex];
                this.speakText(current.hiragana);
            },

            // å·¥å…·å‡½æ•¸
            shuffleArray: function(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            },

            // å­¸ç¿’é€²åº¦åŠŸèƒ½
            saveProgress: function(score, total) {
                const progress = JSON.parse(localStorage.getItem('vocabProgress') || '{}');
                const today = new Date().toISOString().split('T')[0];
                
                if (!progress[today]) {
                    progress[today] = { correct: 0, total: 0 };
                }
                
                progress[today].correct += score;
                progress[today].total += total;
                
                localStorage.setItem('vocabProgress', JSON.stringify(progress));
            },

            loadProgress: function() {
                const progress = JSON.parse(localStorage.getItem('vocabProgress') || '{}');
                return progress;
            },

            showProgressStats: function() {
                const progress = this.loadProgress();
                const statsDiv = document.getElementById('progressStats');
                
                if (Object.keys(progress).length === 0) {
                    statsDiv.innerHTML = '<p>å°šç„¡å­¸ç¿’è¨˜éŒ„</p>';
                    return;
                }
                
                let html = '';
                let totalCorrect = 0;
                let totalQuestions = 0;
                
                // ä¾æ—¥æœŸé¡¯ç¤ºé€²åº¦
                const dates = Object.keys(progress).sort().reverse();
                dates.forEach(date => {
                    const data = progress[date];
                    const percentage = Math.round((data.correct / data.total) * 100);
                    totalCorrect += data.correct;
                    totalQuestions += data.total;
                    
                    html += `
                        <div class="stats">
                            <strong>${date}</strong><br>
                            ç­”å°: ${data.correct}/${data.total} (${percentage}%)
                        </div>
                    `;
                });
                
                // ç¸½è¨ˆ
                const totalPercentage = Math.round((totalCorrect / totalQuestions) * 100);
                html = `
                    <div class="stats" style="background: #e6fffa;">
                        <strong>ç¸½è¨ˆ</strong><br>
                        ç­”å°: ${totalCorrect}/${totalQuestions} (${totalPercentage}%)
                    </div>
                ` + html;
                
                statsDiv.innerHTML = html;
            }
        };

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        document.addEventListener('DOMContentLoaded', function() {
            app.init();
        });
    </script>
</body>
</html>